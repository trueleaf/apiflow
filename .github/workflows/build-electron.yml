name: Build Electron

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: false
        default: 'manual-build'

jobs:
  test-web:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: npm ci --include=optional
        env:
          npm_config_ignore_optional: true
          npm_config_ignore_scripts: false
      
      - name: è·å–Playwrightç‰ˆæœ¬
        id: playwright-version
        run: echo "version=$(node -p "require('./packages/web/package.json').devDependencies['@playwright/test']")" >> $GITHUB_OUTPUT
        
      - name: ç¼“å­˜Playwrightæµè§ˆå™¨
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}
          
      - name: å®‰è£…Playwrightæµè§ˆå™¨
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps
        working-directory: packages/web
        
      - name: å®‰è£…Playwrightç³»ç»Ÿä¾èµ–
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps
        working-directory: packages/web
        
      - name: æ„å»ºWebåº”ç”¨
        run: npm run web:build
        
      - name: è¿è¡ŒE2Eæµ‹è¯•
        run: npm run test
        working-directory: packages/web
        env:
          CI: true
          
      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: packages/web/playwright-report/
          retention-days: 30
          
      - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: packages/web/test-results/
          retention-days: 30

  build-windows:
    needs: [test-web]
    runs-on: windows-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: npm ci --include=optional
        env:
          npm_config_ignore_optional: true
          npm_config_ignore_scripts: false
        
      - name: æ‰“åŒ…Windowsåº”ç”¨
        run: npm run web:build:app:win
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          npm_config_target_platform: win32
          
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: apiflow-windows
          path: |
            packages/web/release/*.exe
            packages/web/release/*.zip
            packages/web/release/win-unpacked/
            packages/web/release/Apiflow-*-x64
            packages/web/release/Apiflow-*-arm64
          retention-days: 30
          
  build-linux:
    needs: [test-web]
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: npm ci --include=optional
        env:
          npm_config_ignore_optional: true
          npm_config_ignore_scripts: false
        
      - name: æ‰“åŒ…Linuxåº”ç”¨
        run: npm run web:build:app:linux
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          npm_config_target_arch: x64
          npm_config_target_platform: linux
          
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: apiflow-linux
          path: |
            packages/web/release/*.AppImage
            packages/web/release/*.deb
          retention-days: 30
          
  build-macos:
    needs: [test-web]
    runs-on: macos-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: npm ci --include=optional
        env:
          npm_config_ignore_optional: true
          npm_config_ignore_scripts: false
        
      - name: æ‰“åŒ…macOSåº”ç”¨
        run: npm run web:build:app:mac
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          npm_config_target_platform: darwin
          
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: apiflow-macos
          path: |
            packages/web/release/*.dmg
            packages/web/release/*.zip
            packages/web/release/*.app
            packages/web/release/mac/
          retention-days: 30
          
  create-release:
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        
      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v1
        with:
          files: |
            apiflow-windows/*
            apiflow-linux/*
            apiflow-macos/*
          tag_name: ${{ github.ref_name }}
          name: Apiflow ${{ github.ref_name }}
          body: |
           ## ğŸ“¦ Downloads
            
            ### Windows
            
            #### Installer
            - **Windows x64**: `Apiflow-*-x64.exe`
            - **Windows ARM64**: `Apiflow-*-arm64.exe`
            
            #### Portable
            - **Windows x64**: `Apiflow-*-x64.zip`
            - **Windows ARM64**: `Apiflow-*-arm64.zip`

            #### Generic (no-extension executable)
            - **Windows x64**: `Apiflow-*-x64`
            - **Windows ARM64**: `Apiflow-*-arm64`

            #### Unpacked (win-unpacked)
            - **Windows**: `win-unpacked/` (Raw application files for advanced users)

            ### Linux
            
            #### AppImage (Recommended)
            - **Linux x64**: `Apiflow-*-x64.AppImage`
            - **Linux ARM64**: `Apiflow-*-arm64.AppImage`
            
            #### Debian Package
            - **Linux x64**: `Apiflow-*-x64.deb`
            - **Linux ARM64**: `Apiflow-*-arm64.deb`
            
            ### macOS
            
            #### DMG Installer (Recommended)
            - **macOS Intel**: `Apiflow-*-x64.dmg`
            - **macOS Apple Silicon**: `Apiflow-*-arm64.dmg`
            
            #### ZIP Archive
            - **macOS Intel**: `Apiflow-*-x64-mac.zip`
            - **macOS Apple Silicon**: `Apiflow-*-arm64-mac.zip`
            
            ## ğŸ“¦ ä¸‹è½½åœ°å€
            
            ### Windowsç‰ˆæœ¬
            
            #### å®‰è£…ç‰ˆ
            - **Windows x64**: `Apiflow-*-x64.exe`
            - **Windows ARM64**: `Apiflow-*-arm64.exe`
            
            #### ä¾¿æºç‰ˆ
            - **Windows x64**: `Apiflow-*-x64.zip`
            - **Windows ARM64**: `Apiflow-*-arm64.zip`

            #### é€šç”¨ï¼ˆæ— æ‰©å±•åï¼‰
            - **Windows x64**: `Apiflow-*-x64`
            - **Windows ARM64**: `Apiflow-*-arm64`

            #### è§£å‹ç‰ˆ (win-unpacked)
            - **Windows**: `win-unpacked/` (åŸå§‹åº”ç”¨ç¨‹åºæ–‡ä»¶ï¼Œé€‚åˆé«˜çº§ç”¨æˆ·)

            ### Linuxç‰ˆæœ¬
            
            #### AppImage (æ¨è)
            - **Linux x64**: `Apiflow-*-x64.AppImage`
            - **Linux ARM64**: `Apiflow-*-arm64.AppImage`
            
            #### DebianåŒ…
            - **Linux x64**: `Apiflow-*-x64.deb`
            - **Linux ARM64**: `Apiflow-*-arm64.deb`
            
            ### macOSç‰ˆæœ¬
            
            #### DMGå®‰è£…åŒ… (æ¨è)
            - **macOS Intel**: `Apiflow-*-x64.dmg`
            - **macOS Apple Silicon**: `Apiflow-*-arm64.dmg`
            
            #### ZIPå‹ç¼©åŒ…
            - **macOS Intel**: `Apiflow-*-x64-mac.zip`
            - **macOS Apple Silicon**: `Apiflow-*-arm64-mac.zip`
            
            ## ğŸš€ What's New
            
            Please check the commit history for detailed changes.
            
            ## ğŸš€ æ›´æ–°å†…å®¹
            
            è¯·æŸ¥çœ‹æäº¤è®°å½•äº†è§£è¯¦ç»†æ›´æ”¹ã€‚
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
