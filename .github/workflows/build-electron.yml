name: Build Electron
on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (例如: v1.0.0-beta.1)'
        required: false
        default: 'manual-build'
      pre_release:
        description: '是否作为预发布版本'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '20'
  
jobs:
  # 第一阶段：Web应用测试和构建
  test-web:
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      is_pre_release: ${{ steps.get-version.outputs.is_pre_release }}
      tag_name: ${{ steps.get-version.outputs.tag_name }}
      create_tag: ${{ steps.get-version.outputs.create_tag }}
      is_manual: ${{ github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 获取版本信息
        id: get-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.pre_release }}" = "true" ]; then
              IS_PRE_RELEASE="true"
            else
              IS_PRE_RELEASE="false"
            fi
            
            if [ "${{ github.event.inputs.version }}" != "manual-build" ]; then
              VERSION="${{ github.event.inputs.version }}"
              # 手动指定版本时创建tag
              CREATE_TAG="true"
            else
              # 生成带时间戳的预发布版本，不创建tag
              TIMESTAMP=$(date +%Y%m%d%H%M%S)
              VERSION="v0.0.0-pre.$TIMESTAMP"
              IS_PRE_RELEASE="true"
              CREATE_TAG="false"
            fi
            
            TAG_NAME="$VERSION"
          else
            # 从tag获取版本
            VERSION="${GITHUB_REF#refs/tags/}"
            IS_PRE_RELEASE="false"
            TAG_NAME="$VERSION"
            CREATE_TAG="false"  # tag已存在
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_pre_release=$IS_PRE_RELEASE" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "create_tag=$CREATE_TAG" >> $GITHUB_OUTPUT
          
          echo "版本: $VERSION"
          echo "预发布: $IS_PRE_RELEASE"
          echo "标签: $TAG_NAME"
          echo "创建标签: $CREATE_TAG"

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 安装依赖 (web)
        run: npm ci
        working-directory: packages/web

      - name: 安装依赖 (server)
        run: npm ci
        working-directory: packages/server
        
      - name: 安装 Linux 依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libgtk-3-0 libgbm1 libnss3 libxss1 libxtst6 libnotify4 libatspi2.0-0 libdrm2 libxcb-dri3-0 libx11-xcb1

      - name: 构建 Web + Electron 资源
        run: npm run web:build:app:pack
        env:
          APP_VERSION: ${{ steps.get-version.outputs.version }}

  # Windows 构建
  build-windows:
    needs: test-web
    runs-on: windows-latest
    
    outputs:
      artifact_name: ${{ steps.setup.outputs.artifact_name }}
      asset_name: ${{ steps.setup.outputs.asset_name }}

    steps:
      - name: 设置变量
        id: setup
        run: |
          $version = "${{ needs.test-web.outputs.version }}"
          $artifactName = "electron-app-windows-$version"
          $assetName = "app-windows-$version.exe"
          
          echo "artifact_name=$artifactName" >> $env:GITHUB_OUTPUT
          echo "asset_name=$assetName" >> $env:GITHUB_OUTPUT
          
          Write-Host "Artifact: $artifactName"
          Write-Host "Asset: $assetName"

      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 安装依赖
        run: npm ci

      - name: 打包 Windows
        run: npm run web:build:app:win
        env:
          APP_VERSION: ${{ needs.test-web.outputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: 查找并重命名安装程序
        run: |
          Write-Host "当前目录: $(Get-Location)"
          Write-Host "目录结构:"
          Get-ChildItem -Recurse -Depth 2 | Format-Table Name, FullName
          
          # 查找所有的.exe文件
          $exeFiles = Get-ChildItem -Recurse -Filter "*.exe" -Depth 3 | Where-Object { 
            $_.FullName -notlike "*node_modules*" -and 
            $_.FullName -notlike "*\.git\*" -and
            $_.DirectoryName -like "*dist*" -or $_.DirectoryName -like "*release*"
          }
          
          Write-Host "找到的.exe文件:"
          $exeFiles | Format-Table Name, Directory
          
          if ($exeFiles.Count -gt 0) {
            $firstExe = $exeFiles[0]
            $newName = "${{ steps.setup.outputs.asset_name }}"
            $newPath = Join-Path -Path $firstExe.DirectoryName -ChildPath $newName
            Write-Host "重命名: $($firstExe.FullName) -> $newPath"
            Rename-Item -Path $firstExe.FullName -NewName $newName
          } else {
            Write-Host "错误: 未找到任何.exe文件"
            # 创建测试文件用于调试
            New-Item -Path "test-app.exe" -ItemType File -Force
            exit 1
          }

      - name: 上传 Windows 构建产物
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setup.outputs.artifact_name }}
          path: |
            **/*.exe
            !node_modules/**/*
          retention-days: 7

  # Linux 构建
  build-linux:
    needs: test-web
    runs-on: ubuntu-latest
    
    outputs:
      artifact_name: ${{ steps.setup.outputs.artifact_name }}
      asset_name: ${{ steps.setup.outputs.asset_name }}

    steps:
      - name: 设置变量
        id: setup
        run: |
          version="${{ needs.test-web.outputs.version }}"
          artifact_name="electron-app-linux-$version"
          asset_name="app-linux-$version.AppImage"
          
          echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT
          echo "asset_name=$asset_name" >> $GITHUB_OUTPUT
          
          echo "Artifact: $artifact_name"
          echo "Asset: $asset_name"

      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 安装依赖
        run: npm ci

      - name: 打包 Linux
        run: npm run web:build:app:linux
        env:
          APP_VERSION: ${{ needs.test-web.outputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          npm_config_target_platform: linux

      - name: 查找构建文件
        run: |
          echo "查找构建文件..."
          find . -name "*.AppImage" -type f 2>/dev/null | head -20
          echo "当前目录内容:"
          ls -la
          echo "dist目录内容:"
          ls -la dist/ 2>/dev/null || echo "dist目录不存在"
          echo "release目录内容:"
          ls -la release/ 2>/dev/null || echo "release目录不存在"

      - name: 重命名 AppImage 文件
        run: |
          # 查找AppImage文件
          APPIMAGE_FILE=$(find . -name "*.AppImage" -type f 2>/dev/null | grep -v node_modules | head -1)
          
          if [ -n "$APPIMAGE_FILE" ]; then
            echo "找到AppImage文件: $APPIMAGE_FILE"
            NEW_NAME="${{ steps.setup.outputs.asset_name }}"
            echo "重命名为: $NEW_NAME"
            mv "$APPIMAGE_FILE" "$NEW_NAME"
            echo "重命名完成"
          else
            echo "警告: 未找到AppImage文件，创建测试文件用于调试"
            touch "app-linux-test.AppImage"
          fi

      - name: 上传 Linux 构建产物
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setup.outputs.artifact_name }}
          path: |
            *.AppImage
            dist/*.AppImage
            release/*.AppImage
          retention-days: 7

  # macOS 构建
  build-macos:
    needs: test-web
    runs-on: macos-latest
    
    outputs:
      artifact_name: ${{ steps.setup.outputs.artifact_name }}
      asset_name: ${{ steps.setup.outputs.asset_name }}

    steps:
      - name: 设置变量
        id: setup
        run: |
          version="${{ needs.test-web.outputs.version }}"
          artifact_name="electron-app-macos-$version"
          asset_name="app-macos-$version.dmg"
          
          echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT
          echo "asset_name=$asset_name" >> $GITHUB_OUTPUT
          
          echo "Artifact: $artifact_name"
          echo "Asset: $asset_name"

      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 安装依赖
        run: npm ci

      - name: 打包 macOS
        run: npm run web:build:app:mac
        env:
          APP_VERSION: ${{ needs.test-web.outputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          npm_config_target_platform: darwin

      - name: 查找构建文件
        run: |
          echo "查找构建文件..."
          find . -name "*.dmg" -type f 2>/dev/null | head -20
          echo "当前目录内容:"
          ls -la
          echo "dist目录内容:"
          ls -la dist/ 2>/dev/null || echo "dist目录不存在"
          echo "release目录内容:"
          ls -la release/ 2>/dev/null || echo "release目录不存在"

      - name: 重命名 DMG 文件
        run: |
          # 查找dmg文件
          DMG_FILE=$(find . -name "*.dmg" -type f 2>/dev/null | grep -v node_modules | head -1)
          
          if [ -n "$DMG_FILE" ]; then
            echo "找到DMG文件: $DMG_FILE"
            NEW_NAME="${{ steps.setup.outputs.asset_name }}"
            echo "重命名为: $NEW_NAME"
            mv "$DMG_FILE" "$NEW_NAME"
            echo "重命名完成"
          else
            echo "警告: 未找到DMG文件，创建测试文件用于调试"
            touch "app-macos-test.dmg"
          fi

      - name: 上传 macOS 构建产物
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setup.outputs.artifact_name }}
          path: |
            *.dmg
            dist/*.dmg
            release/*.dmg
          retention-days: 7

  # 创建 Git Tag（仅手动构建且指定版本时）
  create-tag:
    needs: test-web
    runs-on: ubuntu-latest
    if: needs.test-web.outputs.create_tag == 'true'
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 配置 Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: 创建 Git Tag
        run: |
          TAG_NAME="${{ needs.test-web.outputs.tag_name }}"
          echo "创建标签: $TAG_NAME"
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"
          echo "标签创建成功"

  # 创建 GitHub Release
  create-release:
    needs: 
      - test-web
      - build-windows
      - build-linux
      - build-macos
      - create-tag
    runs-on: ubuntu-latest
    if: ${{ always() && (needs.build-windows.result == 'success' || needs.build-linux.result == 'success' || needs.build-macos.result == 'success') }}
    
    steps:
      - name: 检出代码（仅用于获取 tag 信息）
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 下载所有构建产物
        uses: actions/download-artifact@v4
        with:
          pattern: electron-app-*
          merge-multiple: true
          path: release_assets/

      - name: 查看下载的文件
        run: |
          echo "下载的文件列表:"
          find release_assets/ -type f 2>/dev/null || echo "没有找到文件"
          echo "目录结构:"
          ls -la release_assets/

      - name: 重命名和组织文件
        run: |
          # 创建发布目录
          mkdir -p publish
          
          # 移动并重命名 Windows 文件
          if find release_assets/ -name "*.exe" -type f | head -1 | grep -q .; then
            WIN_EXE=$(find release_assets/ -name "*.exe" -type f | head -1)
            if [ -f "$WIN_EXE" ]; then
              mv "$WIN_EXE" "publish/${{ needs.build-windows.outputs.asset_name }}"
              echo "Windows 文件已准备: publish/${{ needs.build-windows.outputs.asset_name }}"
            fi
          fi
          
          # 移动并重命名 Linux 文件
          if find release_assets/ -name "*.AppImage" -type f | head -1 | grep -q .; then
            LINUX_APPIMAGE=$(find release_assets/ -name "*.AppImage" -type f | head -1)
            if [ -f "$LINUX_APPIMAGE" ]; then
              mv "$LINUX_APPIMAGE" "publish/${{ needs.build-linux.outputs.asset_name }}"
              echo "Linux 文件已准备: publish/${{ needs.build-linux.outputs.asset_name }}"
            fi
          fi
          
          # 移动并重命名 macOS 文件
          if find release_assets/ -name "*.dmg" -type f | head -1 | grep -q .; then
            MAC_DMG=$(find release_assets/ -name "*.dmg" -type f | head -1)
            if [ -f "$MAC_DMG" ]; then
              mv "$MAC_DMG" "publish/${{ needs.build-macos.outputs.asset_name }}"
              echo "macOS 文件已准备: publish/${{ needs.build-macos.outputs.asset_name }}"
            fi
          fi
          
          echo "最终发布文件:"
          ls -la publish/

      - name: 创建 GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.test-web.outputs.tag_name }}
          name: Release ${{ needs.test-web.outputs.version }}
          body: |
            ### 版本 ${{ needs.test-web.outputs.version }}
            
            **构建信息:**
            - 触发方式: ${{ github.event_name }}
            - 提交: ${{ github.sha }}
            - 构建时间: ${{ github.run_created_at }}
            
            **构建状态:**
            - Windows: ${{ needs.build-windows.result }}
            - Linux: ${{ needs.build-linux.result }}
            - macOS: ${{ needs.build-macos.result }}
            
            **下载链接:**
            ${{ needs.build-windows.result == 'success' && format('- Windows: {0}', needs.build-windows.outputs.asset_name) || '' }}
            ${{ needs.build-linux.result == 'success' && format('- Linux: {0}', needs.build-linux.outputs.asset_name) || '' }}
            ${{ needs.build-macos.result == 'success' && format('- macOS: {0}', needs.build-macos.outputs.asset_name) || '' }}
            
            **使用说明:**
            1. 下载对应平台的安装程序
            2. 运行安装程序
            3. 如有问题，请查看文档或提交 Issue
            
          prerelease: ${{ needs.test-web.outputs.is_pre_release == 'true' }}
          draft: false
          generate_release_notes: true
          files: publish/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
