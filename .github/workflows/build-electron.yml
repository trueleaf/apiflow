name: Build Electron
on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (例如: v1.0.0-beta.1)'
        required: false
        default: 'manual-build'
      pre_release:
        description: '是否作为预发布版本'
        required: false
        default: true
        type: boolean
  release:
    types: [created, published]

env:
  NODE_VERSION: '20'

permissions:
  contents: write
  
jobs:
  # 第一阶段：Web应用测试和构建
  test-web:
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      is_pre_release: ${{ steps.get-version.outputs.is_pre_release }}
      tag_name: ${{ steps.get-version.outputs.tag_name }}
      create_tag: ${{ steps.get-version.outputs.create_tag }}
      is_manual: ${{ github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 获取版本信息
        id: get-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.pre_release }}" = "true" ]; then
              IS_PRE_RELEASE="true"
            else
              IS_PRE_RELEASE="false"
            fi
            
            if [ "${{ github.event.inputs.version }}" != "manual-build" ]; then
              VERSION="${{ github.event.inputs.version }}"
              # 手动指定版本时创建tag
              CREATE_TAG="true"
            else
              # 生成带时间戳的预发布版本，不创建tag
              TIMESTAMP=$(date +%Y%m%d%H%M%S)
              VERSION="v0.0.0-pre.$TIMESTAMP"
              IS_PRE_RELEASE="true"
              CREATE_TAG="false"
            fi
            
            TAG_NAME="$VERSION"
          elif [ "${{ github.event_name }}" = "release" ]; then
            # 从 release 事件获取版本
            VERSION="${{ github.event.release.tag_name }}"
            TAG_NAME="$VERSION"
            CREATE_TAG="false"
            # 判断是否为预发布
            if [ "${{ github.event.release.prerelease }}" = "true" ]; then
              IS_PRE_RELEASE="true"
            else
              IS_PRE_RELEASE="false"
            fi
          else
            # 从tag获取版本
            VERSION="${GITHUB_REF#refs/tags/}"
            IS_PRE_RELEASE="false"
            TAG_NAME="$VERSION"
            CREATE_TAG="false"  # tag已存在
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_pre_release=$IS_PRE_RELEASE" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "create_tag=$CREATE_TAG" >> $GITHUB_OUTPUT
          
          echo "版本: $VERSION"
          echo "预发布: $IS_PRE_RELEASE"
          echo "标签: $TAG_NAME"
          echo "创建标签: $CREATE_TAG"

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            packages/web/package-lock.json
            packages/server/package-lock.json

      - name: 安装依赖 (web)
        run: npm ci
        working-directory: packages/web

      - name: 安装依赖 (server)
        run: npm ci
        working-directory: packages/server

      - name: 强制安装 rolldown Linux 绑定
        run: npm install --no-save @rolldown/binding-linux-x64-gnu
        working-directory: packages/web
        
      - name: 安装 Linux 依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libgtk-3-0 libgbm1 libnss3 libxss1 libxtst6 libnotify4 libatspi2.0-0 libdrm2 libxcb-dri3-0 libx11-xcb1

      - name: 构建 Web + Electron 资源
        run: npm run web:build:ci:pack
        env:
          APP_VERSION: ${{ steps.get-version.outputs.version }}

  # Windows 构建
  build-windows:
    needs: [test-web, create-tag]
    runs-on: windows-latest
    if: always() && needs.test-web.result == 'success' && (needs.create-tag.result == 'success' || needs.create-tag.result == 'skipped')

    outputs:
      artifact_name: ${{ steps.setup.outputs.artifact_name }}
      asset_name: ${{ steps.setup.outputs.asset_name }}

    steps:
      - name: 设置变量
        id: setup
        run: |
          $version = "${{ needs.test-web.outputs.version }}"
          $artifactName = "electron-app-windows-$version"
          $assetName = "app-windows-$version.exe"
          
          echo "artifact_name=$artifactName" >> $env:GITHUB_OUTPUT
          echo "asset_name=$assetName" >> $env:GITHUB_OUTPUT
          
          Write-Host "Artifact: $artifactName"
          Write-Host "Asset: $assetName"

      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 拉取最新tags
        run: git fetch --tags --force

      - name: 切换到对应tag
        if: needs.test-web.outputs.create_tag == 'true'
        run: |
          $tagName = "${{ needs.test-web.outputs.tag_name }}"
          Write-Host "切换到tag: $tagName"
          git checkout "$tagName"
          git describe --tags

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            packages/web/package-lock.json
            packages/server/package-lock.json

      - name: 安装依赖 (web)
        run: npm ci
        working-directory: packages/web

      - name: 安装依赖 (server)
        run: npm ci
        working-directory: packages/server

      - name: 修改 package.json 版本号
        run: |
          $version = "${{ needs.test-web.outputs.version }}"
          $versionNoV = $version -replace '^v', ''
          
          # 规范化版本号：将 beta7 转换为 beta.7，alpha3 转换为 alpha.3 等
          $versionNoV = $versionNoV -replace '-(alpha|beta|rc)(\d+)', '-$1.$2'
          
          $packagePath = "packages/web/package.json"
          $packageJson = Get-Content $packagePath -Raw | ConvertFrom-Json
          $packageJson.version = $versionNoV
          $packageJson | ConvertTo-Json -Depth 100 | Set-Content $packagePath
          
          Write-Host "✅ 已将 package.json version 修改为: $versionNoV"

      - name: 打包并发布 Windows
        run: npm run web:build:ci:win
        env:
          APP_VERSION: ${{ needs.test-web.outputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          IS_PRE_RELEASE: ${{ needs.test-web.outputs.is_pre_release }}

      - name: 检查构建产物
        run: |
          Write-Host "检查 release 目录..."
          if (Test-Path "packages/web/release") {
            Get-ChildItem -Path "packages/web/release" -Recurse | Select-Object FullName, Length | Format-Table -AutoSize
          } else {
            Write-Host "❌ release 目录不存在"
          }

      - name: 上传更新产物 (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: update-windows
          if-no-files-found: error
          path: |
            packages/web/release/*.exe
            packages/web/release/latest.yml

      - name: 上传安装包到 GitHub Release
        if: needs.test-web.outputs.create_tag == 'true' || github.event_name == 'push'
        run: |
          TAG_NAME="${{ needs.test-web.outputs.tag_name }}"
          
          # 等待 Release 创建完成
          echo "等待 Release 创建..."
          for i in {1..20}; do
            if gh release view "$TAG_NAME" >/dev/null 2>&1; then
              echo "Release 已存在"
              break
            fi
            echo "等待中... ($i/20)"
            sleep 3
          done
          
          # 上传所有构建产物
          echo "上传构建产物到 Release..."
          cd packages/web/release
          
          # 上传所有 exe 文件
          for file in *.exe; do
            if [ -f "$file" ]; then
              echo "上传: $file"
              gh release upload "$TAG_NAME" "$file" --clobber || echo "上传 $file 失败（可能已存在）"
            fi
          done
          
          # 上传 yml 文件
          if [ -f "latest.yml" ]; then
            echo "上传: latest.yml"
            gh release upload "$TAG_NAME" "latest.yml" --clobber || echo "上传 latest.yml 失败（可能已存在）"
          fi
          
          echo "✅ Windows 产物上传完成"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash

  # Linux 构建
  build-linux:
    needs: [test-web, create-tag]
    runs-on: ubuntu-latest
    if: always() && needs.test-web.result == 'success' && (needs.create-tag.result == 'success' || needs.create-tag.result == 'skipped')
    
    outputs:
      artifact_name: ${{ steps.setup.outputs.artifact_name }}
      asset_name: ${{ steps.setup.outputs.asset_name }}
      asset_name_arm64: ${{ steps.setup.outputs.asset_name_arm64 }}

    steps:
      - name: 设置变量
        id: setup
        run: |
          version="${{ needs.test-web.outputs.version }}"
          artifact_name="electron-app-linux-$version"
          asset_name="app-linux-$version.AppImage"
          asset_name_arm64="app-linux-$version-arm64.AppImage"

          echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT
          echo "asset_name=$asset_name" >> $GITHUB_OUTPUT
          echo "asset_name_arm64=$asset_name_arm64" >> $GITHUB_OUTPUT

          echo "Artifact: $artifact_name"
          echo "Asset: $asset_name"
          echo "Asset (arm64): $asset_name_arm64"

      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 拉取最新tags
        run: git fetch --tags --force

      - name: 切换到对应tag
        if: needs.test-web.outputs.create_tag == 'true'
        run: |
          tag_name="${{ needs.test-web.outputs.tag_name }}"
          echo "切换到tag: $tag_name"
          git checkout "$tag_name"
          git describe --tags

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            packages/web/package-lock.json
            packages/server/package-lock.json

      - name: 安装依赖 (web)
        run: npm ci
        working-directory: packages/web

      - name: 安装依赖 (server)
        run: npm ci
        working-directory: packages/server

      - name: 强制安装 rolldown Linux 绑定
        run: npm install --no-save @rolldown/binding-linux-x64-gnu
        working-directory: packages/web

      - name: 修改 package.json 版本号
        run: |
          VERSION="${{ needs.test-web.outputs.version }}"
          VERSION_NO_V="${VERSION#v}"
          
          # 规范化版本号：将 beta7 转换为 beta.7，alpha3 转换为 alpha.3 等
          VERSION_NO_V=$(echo "$VERSION_NO_V" | sed -E 's/-(alpha|beta|rc)([0-9]+)/-\1.\2/g')
          
          cd packages/web
          
          # 使用 jq 修改 version 字段
          jq --arg version "$VERSION_NO_V" '.version = $version' package.json > package.json.tmp
          mv package.json.tmp package.json
          
          echo "✅ 已将 package.json version 修改为: $VERSION_NO_V"

      - name: 打包并发布 Linux
        run: npm run web:build:ci:linux
        env:
          APP_VERSION: ${{ needs.test-web.outputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          IS_PRE_RELEASE: ${{ needs.test-web.outputs.is_pre_release }}
          npm_config_target_platform: linux

      - name: 检查构建产物
        run: |
          echo "检查 release 目录..."
          if [ -d "packages/web/release" ]; then
            ls -lh packages/web/release/
          else
            echo "❌ release 目录不存在"
          fi

      - name: 上传更新产物 (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: update-linux
          if-no-files-found: error
          path: |
            packages/web/release/*.AppImage
            packages/web/release/*.deb
            packages/web/release/latest-linux.yml

      - name: 上传安装包到 GitHub Release
        if: needs.test-web.outputs.create_tag == 'true' || github.event_name == 'push'
        run: |
          TAG_NAME="${{ needs.test-web.outputs.tag_name }}"
          
          # 等待 Release 创建完成
          echo "等待 Release 创建..."
          for i in {1..20}; do
            if gh release view "$TAG_NAME" >/dev/null 2>&1; then
              echo "Release 已存在"
              break
            fi
            echo "等待中... ($i/20)"
            sleep 3
          done
          
          # 上传所有构建产物
          echo "上传构建产物到 Release..."
          cd packages/web/release
          
          # 上传所有 AppImage 文件
          for file in *.AppImage; do
            if [ -f "$file" ]; then
              echo "上传: $file"
              gh release upload "$TAG_NAME" "$file" --clobber || echo "上传 $file 失败（可能已存在）"
            fi
          done
          
          # 上传所有 deb 文件
          for file in *.deb; do
            if [ -f "$file" ]; then
              echo "上传: $file"
              gh release upload "$TAG_NAME" "$file" --clobber || echo "上传 $file 失败（可能已存在）"
            fi
          done
          
          # 上传 yml 文件
          if [ -f "latest-linux.yml" ]; then
            echo "上传: latest-linux.yml"
            gh release upload "$TAG_NAME" "latest-linux.yml" --clobber || echo "上传 latest-linux.yml 失败（可能已存在）"
          fi
          
          echo "✅ Linux 产物上传完成"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # macOS 构建
  build-macos:
    needs: [test-web, create-tag]
    runs-on: macos-latest
    if: always() && needs.test-web.result == 'success' && (needs.create-tag.result == 'success' || needs.create-tag.result == 'skipped')
    
    outputs:
      artifact_name: ${{ steps.setup.outputs.artifact_name }}
      asset_name: ${{ steps.setup.outputs.asset_name }}

    steps:
      - name: 设置变量
        id: setup
        run: |
          version="${{ needs.test-web.outputs.version }}"
          artifact_name="electron-app-macos-$version"
          asset_name="app-macos-$version.dmg"
          
          echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT
          echo "asset_name=$asset_name" >> $GITHUB_OUTPUT
          
          echo "Artifact: $artifact_name"
          echo "Asset: $asset_name"

      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 拉取最新tags
        run: git fetch --tags --force

      - name: 切换到对应tag
        if: needs.test-web.outputs.create_tag == 'true'
        run: |
          tag_name="${{ needs.test-web.outputs.tag_name }}"
          echo "切换到tag: $tag_name"
          git checkout "$tag_name"
          git describe --tags

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            packages/web/package-lock.json
            packages/server/package-lock.json

      - name: 安装依赖 (web)
        run: npm ci
        working-directory: packages/web

      - name: 安装依赖 (server)
        run: npm ci
        working-directory: packages/server

      - name: 强制安装 rolldown 和 dmg-license 的可选依赖
        run: |
          echo "=== 当前架构信息 ==="
          uname -m
          
          echo "=== 强制安装 rolldown macOS ARM64 绑定 ==="
          npm install --force @rolldown/binding-darwin-arm64
          
          echo "=== 强制安装 dmg-license ==="
          npm install --force dmg-license
          
          echo "=== 验证安装结果 ==="
          ls -la node_modules/@rolldown/ || echo "未找到 @rolldown 目录"
          ls -la node_modules/dmg-license/ || echo "未找到 dmg-license 目录"
        working-directory: packages/web

      - name: 修改 package.json 版本号
        run: |
          VERSION="${{ needs.test-web.outputs.version }}"
          VERSION_NO_V="${VERSION#v}"
          
          # 规范化版本号：将 beta7 转换为 beta.7，alpha3 转换为 alpha.3 等
          VERSION_NO_V=$(echo "$VERSION_NO_V" | sed -E 's/-(alpha|beta|rc)([0-9]+)/-\1.\2/g')
          
          cd packages/web
          
          # 使用 jq 修改 version 字段（macOS 已预装 jq）
          jq --arg version "$VERSION_NO_V" '.version = $version' package.json > package.json.tmp
          mv package.json.tmp package.json
          
          echo "✅ 已将 package.json version 修改为: $VERSION_NO_V"

      - name: 打包并发布 macOS
        run: npm run web:build:ci:mac
        env:
          APP_VERSION: ${{ needs.test-web.outputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          IS_PRE_RELEASE: ${{ needs.test-web.outputs.is_pre_release }}
          npm_config_target_platform: darwin

      - name: 检查构建产物
        run: |
          echo "检查 release 目录..."
          if [ -d "packages/web/release" ]; then
            ls -lh packages/web/release/
          else
            echo "❌ release 目录不存在"
          fi

      - name: 上传更新产物 (macOS)
        uses: actions/upload-artifact@v4
        with:
          name: update-macos
          if-no-files-found: error
          path: |
            packages/web/release/*.dmg
            packages/web/release/*-mac.zip
            packages/web/release/latest-mac.yml

      - name: 上传安装包到 GitHub Release
        if: needs.test-web.outputs.create_tag == 'true' || github.event_name == 'push'
        run: |
          TAG_NAME="${{ needs.test-web.outputs.tag_name }}"
          
          # 等待 Release 创建完成
          echo "等待 Release 创建..."
          for i in {1..20}; do
            if gh release view "$TAG_NAME" >/dev/null 2>&1; then
              echo "Release 已存在"
              break
            fi
            echo "等待中... ($i/20)"
            sleep 3
          done
          
          # 上传所有构建产物
          echo "上传构建产物到 Release..."
          cd packages/web/release
          
          # 上传所有 dmg 文件
          for file in *.dmg; do
            if [ -f "$file" ]; then
              echo "上传: $file"
              gh release upload "$TAG_NAME" "$file" --clobber || echo "上传 $file 失败（可能已存在）"
            fi
          done
          
          # 上传所有 mac.zip 文件
          for file in *-mac.zip; do
            if [ -f "$file" ]; then
              echo "上传: $file"
              gh release upload "$TAG_NAME" "$file" --clobber || echo "上传 $file 失败（可能已存在）"
            fi
          done
          
          # 上传 yml 文件
          if [ -f "latest-mac.yml" ]; then
            echo "上传: latest-mac.yml"
            gh release upload "$TAG_NAME" "latest-mac.yml" --clobber || echo "上传 latest-mac.yml 失败（可能已存在）"
          fi
          
          echo "✅ macOS 产物上传完成"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 上传到自定义更新服务器（rsync + stable/beta + win/mac/linux）
  deploy-update-server:
    needs:
      - test-web
      - build-windows
      - build-linux
      - build-macos
    runs-on: ubuntu-latest
    if: ${{ always() && needs.test-web.result == 'success' && (needs.build-windows.result == 'success' || needs.build-linux.result == 'success' || needs.build-macos.result == 'success') }}

    steps:
      - name: 安装 rsync
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync

      - name: 配置 SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          printf "Host *\n  StrictHostKeyChecking no\n" > ~/.ssh/config

      - name: 计算发布目录
        id: calc
        run: |
          if [ "${{ needs.test-web.outputs.is_pre_release }}" = "true" ]; then
            echo "channel_dir=beta" >> $GITHUB_OUTPUT
          else
            echo "channel_dir=stable" >> $GITHUB_OUTPUT
          fi

      - name: 下载 Windows 更新产物
        if: needs.build-windows.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: update-windows
          path: dist/win

      - name: rsync Windows 更新到服务器
        if: needs.build-windows.result == 'success'
        run: |
          SSH_PORT='${{ secrets.SSH_PORT || 22 }}'
          CHANNEL_DIR='${{ steps.calc.outputs.channel_dir }}'
          REMOTE_ROOT='${{ secrets.UPDATE_SERVER_PATH }}/'"$CHANNEL_DIR"'/win'
          ssh -p "$SSH_PORT" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "rm -rf \"$REMOTE_ROOT\" && mkdir -p \"$REMOTE_ROOT\""
          rsync -az -e "ssh -p $SSH_PORT" dist/win/ "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$REMOTE_ROOT/"

      - name: 下载 Linux 更新产物
        if: needs.build-linux.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: update-linux
          path: dist/linux

      - name: rsync Linux 更新到服务器
        if: needs.build-linux.result == 'success'
        run: |
          SSH_PORT='${{ secrets.SSH_PORT || 22 }}'
          CHANNEL_DIR='${{ steps.calc.outputs.channel_dir }}'
          REMOTE_ROOT='${{ secrets.UPDATE_SERVER_PATH }}/'"$CHANNEL_DIR"'/linux'
          ssh -p "$SSH_PORT" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "rm -rf \"$REMOTE_ROOT\" && mkdir -p \"$REMOTE_ROOT\""
          rsync -az -e "ssh -p $SSH_PORT" dist/linux/ "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$REMOTE_ROOT/"

      - name: 下载 macOS 更新产物
        if: needs.build-macos.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: update-macos
          path: dist/mac

      - name: rsync macOS 更新到服务器
        if: needs.build-macos.result == 'success'
        run: |
          SSH_PORT='${{ secrets.SSH_PORT || 22 }}'
          CHANNEL_DIR='${{ steps.calc.outputs.channel_dir }}'
          REMOTE_ROOT='${{ secrets.UPDATE_SERVER_PATH }}/'"$CHANNEL_DIR"'/mac'
          ssh -p "$SSH_PORT" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "rm -rf \"$REMOTE_ROOT\" && mkdir -p \"$REMOTE_ROOT\""
          rsync -az -e "ssh -p $SSH_PORT" dist/mac/ "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$REMOTE_ROOT/"

  # 创建 Git Tag 和 Release（仅手动构建且指定版本时）
  create-tag:
    needs: test-web
    runs-on: ubuntu-latest
    if: needs.test-web.outputs.create_tag == 'true' || github.event_name == 'release'
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 配置 Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: 创建 Git Tag
        if: needs.test-web.outputs.create_tag == 'true'
        run: |
          TAG_NAME="${{ needs.test-web.outputs.tag_name }}"
          echo "创建标签: $TAG_NAME"
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"
          echo "标签创建成功"

      - name: 确保 GitHub Release 存在
        run: |
          TAG_NAME="${{ needs.test-web.outputs.tag_name }}"
          IS_PRERELEASE="${{ needs.test-web.outputs.is_pre_release }}"
          VERSION="${{ needs.test-web.outputs.version }}"
          
          # 等待一下，确保 tag 已经同步
          sleep 5
          
          # 检查 release 是否已存在
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "Release 已存在: $TAG_NAME"
          else
            echo "创建新 Release: $TAG_NAME"
            if [ "$IS_PRERELEASE" = "true" ]; then
              gh release create "$TAG_NAME" --title "Apiflow $VERSION" --notes "Building release $VERSION..." --prerelease
            else
              gh release create "$TAG_NAME" --title "Apiflow $VERSION" --notes "Building release $VERSION..." --latest
            fi
            echo "✅ Release 创建成功"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 等待所有构建完成（electron-builder 已自动发布到 GitHub Release）
  build-complete:
    needs: 
      - test-web
      - build-windows
      - build-linux
      - build-macos
      - create-tag
    runs-on: ubuntu-latest
    if: ${{ always() && (needs.build-windows.result == 'success' || needs.build-linux.result == 'success' || needs.build-macos.result == 'success') }}
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 等待 Release Assets 上传完成
        run: |
          TAG_NAME="${{ needs.test-web.outputs.tag_name }}"
          
          echo "等待 GitHub Release assets 上传完成..."
          for i in {1..30}; do
            echo "检查第 $i 次..."
            
            # 检查 release 是否存在
            if gh release view "$TAG_NAME" >/dev/null 2>&1; then
              echo "Release 存在，检查 assets..."
              
              # 获取 assets 列表
              ASSETS=$(gh release view "$TAG_NAME" --json assets --jq '.assets[].name')
              ASSET_COUNT=$(echo "$ASSETS" | grep -c ".*" || true)
              
              echo "当前 assets 数量: $ASSET_COUNT"
              echo "Assets:"
              echo "$ASSETS"
              
              # 至少需要有一个安装包文件（.exe, .dmg, .AppImage 等）
              if echo "$ASSETS" | grep -qE '\.(exe|dmg|AppImage)$'; then
                echo "✅ 发现安装包文件，继续更新描述"
                break
              fi
            fi
            
            if [ $i -eq 30 ]; then
              echo "⚠️ 等待超时，但将继续更新 Release 描述"
            fi
            
            sleep 10
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 更新 Release 描述
        run: |
          # 读取模板文件
          TEMPLATE=$(cat .github/release-template.md)
          
          # 替换变量
          VERSION="${{ needs.test-web.outputs.version }}"
          VERSION_NO_V="${VERSION#v}"
          
          # 规范化版本号：将 beta7 转换为 beta.7，alpha3 转换为 alpha.3 等
          VERSION_NO_V=$(echo "$VERSION_NO_V" | sed -E 's/-(alpha|beta|rc)([0-9]+)/-\1.\2/g')
          
          RELEASE_BODY="${TEMPLATE//\{\{VERSION\}\}/$VERSION}"
          RELEASE_BODY="${RELEASE_BODY//\{\{VERSION_NO_V\}\}/$VERSION_NO_V}"
          
          # 保存到临时文件
          echo "$RELEASE_BODY" > /tmp/release-notes.md
          
          TAG_NAME="${{ needs.test-web.outputs.tag_name }}"
          IS_PRERELEASE="${{ needs.test-web.outputs.is_pre_release }}"
          
          # 检查 release 是否存在
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "更新现有 release..."
            if [ "$IS_PRERELEASE" = "true" ]; then
              gh release edit "$TAG_NAME" --notes-file /tmp/release-notes.md --prerelease
            else
              gh release edit "$TAG_NAME" --notes-file /tmp/release-notes.md --latest
            fi
          else
            echo "创建新 release..."
            if [ "$IS_PRERELEASE" = "true" ]; then
              gh release create "$TAG_NAME" --notes-file /tmp/release-notes.md --title "Apiflow $VERSION" --prerelease
            else
              gh release create "$TAG_NAME" --notes-file /tmp/release-notes.md --title "Apiflow $VERSION" --latest
            fi
          fi
          
          echo "✅ Release 描述已更新"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 构建完成通知
        run: |
          echo "✅ 构建已完成，electron-builder 已自动发布到 GitHub Release"
          echo "版本: ${{ needs.test-web.outputs.version }}"
          echo "标签: ${{ needs.test-web.outputs.tag_name }}"
          echo ""
          echo "构建状态:"
          echo "- Windows: ${{ needs.build-windows.result }}"
          echo "- Linux: ${{ needs.build-linux.result }}"
          echo "- macOS: ${{ needs.build-macos.result }}"
          echo ""
          echo "Release 地址: https://github.com/${{ github.repository }}/releases/tag/${{ needs.test-web.outputs.tag_name }}"
