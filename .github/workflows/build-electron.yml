name: Build Electron
on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (例如: v1.0.0-beta.1)'
        required: false
        default: 'manual-build'
      pre_release:
        description: '是否作为预发布版本'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '20'

permissions:
  contents: write
  
jobs:
  # 第一阶段：Web应用测试和构建
  test-web:
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      is_pre_release: ${{ steps.get-version.outputs.is_pre_release }}
      tag_name: ${{ steps.get-version.outputs.tag_name }}
      create_tag: ${{ steps.get-version.outputs.create_tag }}
      is_manual: ${{ github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 获取版本信息
        id: get-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.pre_release }}" = "true" ]; then
              IS_PRE_RELEASE="true"
            else
              IS_PRE_RELEASE="false"
            fi
            
            if [ "${{ github.event.inputs.version }}" != "manual-build" ]; then
              VERSION="${{ github.event.inputs.version }}"
              # 手动指定版本时创建tag
              CREATE_TAG="true"
            else
              # 生成带时间戳的预发布版本，不创建tag
              TIMESTAMP=$(date +%Y%m%d%H%M%S)
              VERSION="v0.0.0-pre.$TIMESTAMP"
              IS_PRE_RELEASE="true"
              CREATE_TAG="false"
            fi
            
            TAG_NAME="$VERSION"
          else
            # 从tag获取版本
            VERSION="${GITHUB_REF#refs/tags/}"
            IS_PRE_RELEASE="false"
            TAG_NAME="$VERSION"
            CREATE_TAG="false"  # tag已存在
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_pre_release=$IS_PRE_RELEASE" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "create_tag=$CREATE_TAG" >> $GITHUB_OUTPUT
          
          echo "版本: $VERSION"
          echo "预发布: $IS_PRE_RELEASE"
          echo "标签: $TAG_NAME"
          echo "创建标签: $CREATE_TAG"

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            packages/web/package-lock.json
            packages/server/package-lock.json

      - name: 安装依赖 (web)
        run: npm ci
        working-directory: packages/web

      - name: 安装依赖 (server)
        run: npm ci
        working-directory: packages/server
        
      - name: 安装 Linux 依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libgtk-3-0 libgbm1 libnss3 libxss1 libxtst6 libnotify4 libatspi2.0-0 libdrm2 libxcb-dri3-0 libx11-xcb1

      - name: 构建 Web + Electron 资源
        run: npm run web:build:app:pack
        env:
          APP_VERSION: ${{ steps.get-version.outputs.version }}

  # Windows 构建
  build-windows:
    needs: [test-web, create-tag]
    runs-on: windows-latest
    if: always() && needs.test-web.result == 'success'

    outputs:
      artifact_name: ${{ steps.setup.outputs.artifact_name }}
      asset_name: ${{ steps.setup.outputs.asset_name }}

    steps:
      - name: 设置变量
        id: setup
        run: |
          $version = "${{ needs.test-web.outputs.version }}"
          $artifactName = "electron-app-windows-$version"
          $assetName = "app-windows-$version.exe"
          
          echo "artifact_name=$artifactName" >> $env:GITHUB_OUTPUT
          echo "asset_name=$assetName" >> $env:GITHUB_OUTPUT
          
          Write-Host "Artifact: $artifactName"
          Write-Host "Asset: $assetName"

      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 拉取最新tags
        run: git fetch --tags --force

      - name: 切换到对应tag
        if: needs.test-web.outputs.create_tag == 'true'
        run: |
          $tagName = "${{ needs.test-web.outputs.tag_name }}"
          Write-Host "切换到tag: $tagName"
          git checkout "$tagName"
          git describe --tags

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            packages/web/package-lock.json
            packages/server/package-lock.json

      - name: 安装依赖 (web)
        run: npm ci
        working-directory: packages/web

      - name: 安装依赖 (server)
        run: npm ci
        working-directory: packages/server

      - name: 调试信息
        run: |
          Write-Host "=== Git 信息 ==="
          git describe --tags --always
          git status
          Write-Host ""
          Write-Host "=== 环境变量 ==="
          Write-Host "APP_VERSION: $env:APP_VERSION"
          Write-Host "IS_PRE_RELEASE: ${{ needs.test-web.outputs.is_pre_release }}"
          Write-Host "TAG_NAME: ${{ needs.test-web.outputs.tag_name }}"
          Write-Host "GH_TOKEN: $(if ($env:GH_TOKEN) { '已设置' } else { '未设置' })"
        env:
          APP_VERSION: ${{ needs.test-web.outputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 打包并发布 Windows
        run: npm run web:build:app:win
        env:
          APP_VERSION: ${{ needs.test-web.outputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          IS_PRE_RELEASE: ${{ needs.test-web.outputs.is_pre_release }}
          PUBLISH: always

  # Linux 构建
  build-linux:
    needs: [test-web, create-tag]
    runs-on: ubuntu-latest
    if: always() && needs.test-web.result == 'success'
    
    outputs:
      artifact_name: ${{ steps.setup.outputs.artifact_name }}
      asset_name: ${{ steps.setup.outputs.asset_name }}
      asset_name_arm64: ${{ steps.setup.outputs.asset_name_arm64 }}

    steps:
      - name: 设置变量
        id: setup
        run: |
          version="${{ needs.test-web.outputs.version }}"
          artifact_name="electron-app-linux-$version"
          asset_name="app-linux-$version.AppImage"
          asset_name_arm64="app-linux-$version-arm64.AppImage"

          echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT
          echo "asset_name=$asset_name" >> $GITHUB_OUTPUT
          echo "asset_name_arm64=$asset_name_arm64" >> $GITHUB_OUTPUT

          echo "Artifact: $artifact_name"
          echo "Asset: $asset_name"
          echo "Asset (arm64): $asset_name_arm64"

      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 拉取最新tags
        run: git fetch --tags --force

      - name: 切换到对应tag
        if: needs.test-web.outputs.create_tag == 'true'
        run: |
          tag_name="${{ needs.test-web.outputs.tag_name }}"
          echo "切换到tag: $tag_name"
          git checkout "$tag_name"
          git describe --tags

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            packages/web/package-lock.json
            packages/server/package-lock.json

      - name: 安装依赖 (web)
        run: npm ci
        working-directory: packages/web

      - name: 安装依赖 (server)
        run: npm ci
        working-directory: packages/server

      - name: 调试信息
        run: |
          echo "=== Git 信息 ==="
          git describe --tags --always
          git status
          echo ""
          echo "=== 环境变量 ==="
          echo "APP_VERSION: ${APP_VERSION}"
          echo "IS_PRE_RELEASE: ${{ needs.test-web.outputs.is_pre_release }}"
          echo "TAG_NAME: ${{ needs.test-web.outputs.tag_name }}"
          echo "GH_TOKEN: $(if [ -n "$GH_TOKEN" ]; then echo '已设置'; else echo '未设置'; fi)"
        env:
          APP_VERSION: ${{ needs.test-web.outputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 打包并发布 Linux
        run: npm run web:build:app:linux
        env:
          APP_VERSION: ${{ needs.test-web.outputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          IS_PRE_RELEASE: ${{ needs.test-web.outputs.is_pre_release }}
          npm_config_target_platform: linux
          PUBLISH: always

  # macOS 构建
  build-macos:
    needs: [test-web, create-tag]
    runs-on: macos-latest
    if: always() && needs.test-web.result == 'success'
    
    outputs:
      artifact_name: ${{ steps.setup.outputs.artifact_name }}
      asset_name: ${{ steps.setup.outputs.asset_name }}

    steps:
      - name: 设置变量
        id: setup
        run: |
          version="${{ needs.test-web.outputs.version }}"
          artifact_name="electron-app-macos-$version"
          asset_name="app-macos-$version.dmg"
          
          echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT
          echo "asset_name=$asset_name" >> $GITHUB_OUTPUT
          
          echo "Artifact: $artifact_name"
          echo "Asset: $asset_name"

      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 拉取最新tags
        run: git fetch --tags --force

      - name: 切换到对应tag
        if: needs.test-web.outputs.create_tag == 'true'
        run: |
          tag_name="${{ needs.test-web.outputs.tag_name }}"
          echo "切换到tag: $tag_name"
          git checkout "$tag_name"
          git describe --tags

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            packages/web/package-lock.json
            packages/server/package-lock.json

      - name: 安装依赖 (web)
        run: npm ci
        working-directory: packages/web

      - name: 安装依赖 (server)
        run: npm ci
        working-directory: packages/server

      - name: 调试信息
        run: |
          echo "=== Git 信息 ==="
          git describe --tags --always
          git status
          echo ""
          echo "=== 环境变量 ==="
          echo "APP_VERSION: ${APP_VERSION}"
          echo "IS_PRE_RELEASE: ${{ needs.test-web.outputs.is_pre_release }}"
          echo "TAG_NAME: ${{ needs.test-web.outputs.tag_name }}"
          echo "GH_TOKEN: $(if [ -n "$GH_TOKEN" ]; then echo '已设置'; else echo '未设置'; fi)"
        env:
          APP_VERSION: ${{ needs.test-web.outputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 打包并发布 macOS
        run: npm run web:build:app:mac
        env:
          APP_VERSION: ${{ needs.test-web.outputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          IS_PRE_RELEASE: ${{ needs.test-web.outputs.is_pre_release }}
          npm_config_target_platform: darwin
          PUBLISH: always

  # 创建 Git Tag（仅手动构建且指定版本时）
  create-tag:
    needs: test-web
    runs-on: ubuntu-latest
    if: needs.test-web.outputs.create_tag == 'true'
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 配置 Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: 创建 Git Tag
        run: |
          TAG_NAME="${{ needs.test-web.outputs.tag_name }}"
          echo "创建标签: $TAG_NAME"
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"
          echo "标签创建成功"

  # 等待所有构建完成（electron-builder 已自动发布到 GitHub Release）
  build-complete:
    needs: 
      - test-web
      - build-windows
      - build-linux
      - build-macos
      - create-tag
    runs-on: ubuntu-latest
    if: ${{ always() && (needs.build-windows.result == 'success' || needs.build-linux.result == 'success' || needs.build-macos.result == 'success') }}
    
    steps:
      - name: 构建完成通知
        run: |
          echo "✅ 构建已完成，electron-builder 已自动发布到 GitHub Release"
          echo "版本: ${{ needs.test-web.outputs.version }}"
          echo "标签: ${{ needs.test-web.outputs.tag_name }}"
          echo ""
          echo "构建状态:"
          echo "- Windows: ${{ needs.build-windows.result }}"
          echo "- Linux: ${{ needs.build-linux.result }}"
          echo "- macOS: ${{ needs.build-macos.result }}"
          echo ""
          echo "Release 地址: https://github.com/${{ github.repository }}/releases/tag/${{ needs.test-web.outputs.tag_name }}"
