#!/usr/bin/env node
/**
 * Setup NPM Registry based on .env configuration
 * This script reads the USE_NPM_MIRROR variable from .env file
 * and configures .npmrc accordingly
 */

const fs = require('fs');
const path = require('path');

// Read .env file
function loadEnv() {
  const env = {};

  // Prefer environment variables (works in Docker build where .env is not in the image)
  if (process.env.USE_NPM_MIRROR != null) {
    env.USE_NPM_MIRROR = String(process.env.USE_NPM_MIRROR).trim();
  }

  const envPath = path.join(__dirname, '..', '.env');
  if (!fs.existsSync(envPath)) {
    if (Object.keys(env).length === 0) {
      console.log('‚ÑπÔ∏è  No .env file found. Using default npm registry.');
    }
    return env;
  }

  const envContent = fs.readFileSync(envPath, 'utf-8');
  
  envContent.split('\n').forEach(line => {
    const trimmedLine = line.trim();
    // Skip comments and empty lines
    if (!trimmedLine || trimmedLine.startsWith('#')) return;
    
    const [key, ...valueParts] = trimmedLine.split('=');
    if (key && valueParts.length > 0) {
      const envKey = key.trim();
      if (env[envKey] == null) {
        env[envKey] = valueParts.join('=').trim();
      }
    }
  });
  
  return env;
}

// Configure .npmrc
function configureNpmrc(useMirror) {
  const npmrcPath = path.join(__dirname, '..', '.npmrc');
  
  const mirrorConfig = `# NPM Mirror Configuration (Auto-generated by setup-npm-registry.js)
# DO NOT EDIT MANUALLY - Changes will be overwritten
# Configure via USE_NPM_MIRROR in .env file

ELECTRON_MIRROR=https://npmmirror.com/mirrors/electron/
ELECTRON_BUILDER_BINARIES_MIRROR=https://npmmirror.com/mirrors/electron-builder-binaries/
registry=https://registry.npmmirror.com
`;

  const defaultConfig = `# NPM Default Configuration (Auto-generated by setup-npm-registry.js)
# DO NOT EDIT MANUALLY - Changes will be overwritten
# Configure via USE_NPM_MIRROR in .env file

# ELECTRON_MIRROR=https://npmmirror.com/mirrors/electron/
# ELECTRON_BUILDER_BINARIES_MIRROR=https://npmmirror.com/mirrors/electron-builder-binaries/
# registry=https://registry.npmmirror.com
`;

  if (useMirror) {
    fs.writeFileSync(npmrcPath, mirrorConfig, 'utf-8');
    console.log('‚úÖ NPM registry configured to use mirror (npmmirror.com)');
  } else {
    fs.writeFileSync(npmrcPath, defaultConfig, 'utf-8');
    console.log('‚úÖ NPM registry configured to use default (npmjs.org)');
  }
}

// Main execution
try {
  const env = loadEnv();
  const useMirror = String(env.USE_NPM_MIRROR || '').toLowerCase() === 'true';
  
  console.log('üîß Configuring NPM registry...');
  console.log(`   USE_NPM_MIRROR: ${useMirror ? 'true (using mirror)' : 'false (using default)'}`);
  
  configureNpmrc(useMirror);
  
} catch (error) {
  console.error('‚ùå Error configuring NPM registry:', error.message);
  process.exit(1);
}
